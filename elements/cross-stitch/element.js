!function(){"use strict";Polymer({is:"cross-stitch",behaviors:[window.sizingBehavior,window.quantizeBehavior,window.pixelateBehavior,window.workerBehavior,window.miscBehavior],properties:{numcolors:{type:Number,observer:"propertyChanged"},gridwidth:{type:Number,observer:"propertyChanged"},imagedata:{type:Object,observer:"propertyChanged"},superPixelData:{type:Object},palette:{type:Array,notify:!0}},ready:function(){this.$.finalOutput.imageSmoothingEnabled=this.$.finalOutput.msImageSmoothingEnabled=this.$.finalOutput.mozImageSmoothingEnabled=this.$.finalOutput.webkitImageSmoothingEnabled=!1;var t=navigator.hardwareConcurrency||4;this.createWorkers("libs.js",t)},propertyChanged:function(){void 0!==this.imagedata&&this.newFile()},newFile:function(){this.startTime=performance.now(),this._scaleImage.bind(this)().then(this._dispatchBuildPalette.bind(this)).then(this._processImage.bind(this))["catch"](this._catchErrors)},_scaleImage:function(){return this.scale({imageData:this.imagedata,newWidth:Polymer.dom(this).node.offsetWidth})},_dispatchBuildPalette:function(t){var e=this;return this.scale({imageData:this.imagedata,newWidth:400}).then(function(t){return e.dispatchWorker("buildPalette",{imageData:t,numColors:e.numcolors+1},[t.data.buffer])}).then(function(e){var i=(e.resizedImageData,e.palette);return Promise.resolve({imageData:t,palette:i})})},_processImage:function(t){var e=this,i=t.imageData,a=t.palette;this._setupSuperPixelData.call(this,i,a),this._resizeOutputCanvas.call(this,i);var r=this.$.finalOutput.getContext("2d"),s={imageData:i,numberOfParts:this.workers.length,pixelHeight:this.superPixelData.pixelHeight},h=!0,n=!1,o=void 0;try{for(var l,u=function(){var t=l.value,i=t.chunk,a=t.chunkStartY;e._dispatchQuantize.bind(e)(i).then(e._dispatchPixelate.bind(e)).then(function(t){var i=t.imageData;r.putImageData(e._convertToRealImageData(i),0,a),console.log("Wrote chunk at "+(performance.now()-e.startTime)+" milliseconds!")})["catch"](e._catchErrors)},p=this.splitGenerator.bind(this)(s)[Symbol.iterator]();!(h=(l=p.next()).done);h=!0)u()}catch(d){n=!0,o=d}finally{try{!h&&p["return"]&&p["return"]()}finally{if(n)throw o}}},_setupSuperPixelData:function(t,e){this.palette=e,this.superPixelData={xPixels:this.gridwidth,yPixels:Math.floor(t.height*(this.gridwidth/t.width))},this.superPixelData.pixelWidth=Math.ceil(t.width/this.superPixelData.xPixels),this.superPixelData.pixelHeight=Math.ceil(t.height/this.superPixelData.yPixels)},_resizeOutputCanvas:function(t){this.$.finalOutput.width=t.width,this.$.finalOutput.height=t.height},_dispatchQuantize:function(t){return this.dispatchWorker("quantize",{imageData:t,palette:this.palette},[t.data.buffer])},_dispatchPixelate:function(t){var e=t.imageData;return this.dispatchWorker("pixelate",{imageData:e,pixelWidth:this.superPixelData.pixelWidth,pixelHeight:this.superPixelData.pixelHeight,xPixels:this.superPixelData.xPixels,yPixels:this.superPixelData.yPixels},[e.data.buffer])}})}();