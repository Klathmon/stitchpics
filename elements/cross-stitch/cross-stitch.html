<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../globalScripts/globalScripts.html">

<dom-module id="cross-stitch">
  <style>:host{font-family:Roboto,Noto,sans-serif;display:block;min-height:200px}#finalOutput{width:100%;-ms-interpolation-mode:nearest-neighbor;image-rendering:-webkit-optimize-contrast;image-rendering:-moz-crisp-edges;image-rendering:pixelated}</style>
  <template>
    <canvas id="finalOutput"></canvas>
  </template>
</dom-module>

<script src="libs.js"></script>

<script>var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,i=function(){return e.URL||e.webkitURL||e},n=t.createElementNS("http://www.w3.org/1999/xhtml","a"),a="download"in n,o=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},r=e.webkitRequestFileSystem,s=e.requestFileSystem||r||e.mozRequestFileSystem,u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",h=0,c=500,d=function(t){var n=function(){"string"==typeof t?i().revokeObjectURL(t):t.remove()};e.chrome?n():setTimeout(n,c)},p=function(e,t,i){t=[].concat(t);for(var n=t.length;n--;){var a=e["on"+t[n]];if("function"==typeof a)try{a.call(e,i||e)}catch(o){u(o)}}},f=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e},m=function(t,u,c){c||(t=f(t));var m,g,v,w=this,y=t.type,b=!1,D=function(){p(w,"writestart progress write writeend".split(" "))},x=function(){if((b||!m)&&(m=i().createObjectURL(t)),g)g.location.href=m;else{var n=e.open(m,"_blank");void 0==n&&"undefined"!=typeof safari&&(e.location.href=m)}w.readyState=w.DONE,D(),d(m)},O=function(e){return function(){return w.readyState!==w.DONE?e.apply(this,arguments):void 0}},P={create:!0,exclusive:!1};return w.readyState=w.INIT,u||(u="download"),a?(m=i().createObjectURL(t),n.href=m,n.download=u,void setTimeout(function(){o(n),D(),d(m),w.readyState=w.DONE})):(e.chrome&&y&&y!==l&&(v=t.slice||t.webkitSlice,t=v.call(t,0,t.size,l),b=!0),r&&"download"!==u&&(u+=".download"),(y===l||r)&&(g=e),s?(h+=t.size,void s(e.TEMPORARY,h,O(function(e){e.root.getDirectory("saved",P,O(function(e){var i=function(){e.getFile(u,P,O(function(e){e.createWriter(O(function(i){i.onwriteend=function(t){g.location.href=e.toURL(),w.readyState=w.DONE,p(w,"writeend",t),d(e)},i.onerror=function(){var e=i.error;e.code!==e.ABORT_ERR&&x()},"writestart progress write abort".split(" ").forEach(function(e){i["on"+e]=w["on"+e]}),i.write(t),w.abort=function(){i.abort(),w.readyState=w.DONE},w.readyState=w.WRITING}),x)}),x)};e.getFile(u,{create:!1},O(function(e){e.remove(),i()}),O(function(e){e.code===e.NOT_FOUND_ERR?i():x()}))}),x)}),x)):void x())},g=m.prototype,v=function(e,t,i){return new m(e,t,i)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,i){return i||(e=f(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(g.abort=function(){var e=this;e.readyState=e.DONE,p(e,"abort")},g.readyState=g.INIT=0,g.WRITING=1,g.DONE=2,g.error=g.onwritestart=g.onprogress=g.onwrite=g.onabort=g.onerror=g.onwriteend=null,v)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),function(e){"use strict";var t,i=e.Uint8Array,n=e.HTMLCanvasElement,a=n&&n.prototype,o=/\s*;\s*base64\s*(?:;|$)/i,r="toDataURL",s=function(e){for(var n,a,o,r=e.length,s=new i(r/4*3|0),u=0,l=0,h=[0,0],c=0,d=0;r--;)a=e.charCodeAt(u++),n=t[a-43],255!==n&&n!==o&&(h[1]=h[0],h[0]=a,d=d<<6|n,c++,4===c&&(s[l++]=d>>>16,61!==h[1]&&(s[l++]=d>>>8),61!==h[0]&&(s[l++]=d),c=0));return s};i&&(t=new i([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),n&&!a.toBlob&&(a.toBlob=function(e,t){if(t||(t="image/png"),this.mozGetAsFile)return void e(this.mozGetAsFile("canvas",t));if(this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(t))return void e(this.msToBlob());var n,a=Array.prototype.slice.call(arguments,1),u=this[r].apply(this,a),l=u.indexOf(","),h=u.substring(l+1),c=o.test(u.substring(0,l));Blob.fake?(n=new Blob,c?n.encoding="base64":n.encoding="URI",n.data=h,n.size=h.length):i&&(n=c?new Blob([s(h)],{type:t}):new Blob([decodeURIComponent(h)],{type:t})),e(n)},a.toDataURLHD?a.toBlobHD=function(){r="toDataURLHD";var e=this.toBlob();return r="toDataURL",e}:a.toBlobHD=a.toBlob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this),function(){"use strict";Polymer({is:"cross-stitch",behaviors:[window.sizingBehavior,window.quantizeBehavior,window.pixelateBehavior,window.workerBehavior,window.miscBehavior,window.dmcColorBehavior],properties:{numcolors:{type:Number,observer:"propertyChanged"},gridwidth:{type:Number,observer:"propertyChanged"},imagedata:{type:Object,observer:"propertyChanged"},usedmccolors:{type:Boolean,observer:"propertyChanged"},hidethegrid:{type:Boolean,observer:"propertyChanged"},superPixelData:{type:Object},palette:{type:Array,notify:!0},numberOfChunksDone:{type:Number,value:0}},ready:function(){var e=this.$.finalOutput;e.imageSmoothingEnabled=e.msImageSmoothingEnabled=e.mozImageSmoothingEnabled=e.webkitImageSmoothingEnabled=!1;var t=navigator.hardwareConcurrency||4;this.createWorkers("libs.js",t),window.addEventListener("resize",_.debounce(this.propertyChanged.bind(this),250))},propertyChanged:function(){void 0!==this.imagedata&&this.newFile()},newFile:function(){this.startTime=performance.now(),this._scaleImage.bind(this)().then(this._dispatchBuildPalette.bind(this)).then(this._processImage.bind(this))["catch"](this._catchErrors)},saveAsImage:function(){this.$.finalOutput.getContext("2d");this.$.finalOutput.toBlob(function(e){saveAs(e,"CrossStitch.png")})},getImageAsURI:function(){return this.$.finalOutput.toDataURL("image/png")},_scaleImage:function(){return this.scale({imageData:this.imagedata,newWidth:Polymer.dom(this).node.offsetWidth})},_dispatchBuildPalette:function(e){return this.dispatchWorker("buildPalette",{imageData:e,numColors:this.numcolors,useDmcColors:this.usedmccolors},[e.data.buffer]).then(function(e){var t=e.imageData,i=e.palette;return Promise.resolve({imageData:t,palette:i})})},_processImage:function(e){var t=this,i=e.imageData,n=e.palette;this._setupSuperPixelData.call(this,i,n),this._resizeOutputCanvas.call(this,i);var a=this.$.finalOutput.getContext("2d"),o={imageData:i,numberOfParts:this.workers.length,pixelHeight:this.superPixelData.pixelHeight},r=!0,s=!1,u=void 0;try{for(var l,h=function(){var e=l.value,i=e.chunk,n=e.chunkStartY;t._dispatchQuantize.bind(t)(i).then(t._dispatchPixelate.bind(t)).then(function(e){var i=e.imageData;a.putImageData(t._convertToRealImageData(i),0,n),console.log("Wrote chunk at "+(performance.now()-t.startTime)+" milliseconds!"),++t.numberOfChunksDone===t.workers.length&&t.fire("crossStitchDone",t._readImageData(t.$.finalOutput))})["catch"](t._catchErrors)},c=this.splitGenerator.bind(this)(o)[Symbol.iterator]();!(r=(l=c.next()).done);r=!0)h()}catch(d){s=!0,u=d}finally{try{!r&&c["return"]&&c["return"]()}finally{if(s)throw u}}},_setupSuperPixelData:function(e,t){this.palette=t,this.superPixelData={xPixels:this.gridwidth,yPixels:Math.floor(e.height*(this.gridwidth/e.width))},this.superPixelData.pixelWidth=Math.ceil(e.width/this.superPixelData.xPixels),this.superPixelData.pixelHeight=Math.ceil(e.height/this.superPixelData.yPixels)},_resizeOutputCanvas:function(e){this.$.finalOutput.width=e.width,this.$.finalOutput.height=e.height},_dispatchQuantize:function(e){return this.dispatchWorker("quantize",{imageData:e,palette:this.palette,useDmcColors:this.usedmccolors},[e.data.buffer])},_dispatchPixelate:function(e){var t=e.imageData;return this.dispatchWorker("pixelate",{imageData:t,pixelWidth:this.superPixelData.pixelWidth,pixelHeight:this.superPixelData.pixelHeight,xPixels:this.superPixelData.xPixels,yPixels:this.superPixelData.yPixels,hideTheGrid:this.hidethegrid},[t.data.buffer])}})}();</script>
