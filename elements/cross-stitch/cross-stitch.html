<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../globalScripts/globalScripts.html">
<link rel="import" href="../workor/workor.html">

<dom-module id="cross-stitch">
  <style>:host{font-family:Roboto,Noto,sans-serif;display:block;min-height:200px}#finalOutput{width:100%;-ms-interpolation-mode:nearest-neighbor;image-rendering:-webkit-optimize-contrast;image-rendering:-moz-crisp-edges;image-rendering:pixelated}</style>
  <template>
    <canvas id="finalOutput"></canvas>
  </template>
</dom-module>

<script>var saveAs=saveAs||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,i=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},a=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),s=e.webkitRequestFileSystem,u=e.requestFileSystem||s||e.mozRequestFileSystem,c=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},d="application/octet-stream",f=0,l=500,h=function(t){var r=function(){"string"==typeof t?n().revokeObjectURL(t):t.remove()};e.chrome?r():setTimeout(r,l)},m=function(e,t,n){t=[].concat(t);for(var r=t.length;r--;){var o=e["on"+t[r]];if("function"==typeof o)try{o.call(e,n||e)}catch(i){c(i)}}},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e},g=function(t,c,l){l||(t=p(t));var g,b,v,w=this,y=t.type,O=!1,I=function(){m(w,"writestart progress write writeend".split(" "))},D=function(){if(b&&a&&"undefined"!=typeof FileReader){var r=new FileReader;return r.onloadend=function(){var e=r.result;b.location.href="data:attachment/file"+e.slice(e.search(/[,;]/)),w.readyState=w.DONE,I()},r.readAsDataURL(t),void(w.readyState=w.INIT)}if((O||!g)&&(g=n().createObjectURL(t)),b)b.location.href=g;else{var o=e.open(g,"_blank");void 0==o&&a&&(e.location.href=g)}w.readyState=w.DONE,I(),h(g)},S=function(e){return function(){return w.readyState!==w.DONE?e.apply(this,arguments):void 0}},k={create:!0,exclusive:!1};return w.readyState=w.INIT,c||(c="download"),o?(g=n().createObjectURL(t),r.href=g,r.download=c,void setTimeout(function(){i(r),I(),h(g),w.readyState=w.DONE})):(e.chrome&&y&&y!==d&&(v=t.slice||t.webkitSlice,t=v.call(t,0,t.size,d),O=!0),s&&"download"!==c&&(c+=".download"),(y===d||s)&&(b=e),u?(f+=t.size,void u(e.TEMPORARY,f,S(function(e){e.root.getDirectory("saved",k,S(function(e){var n=function(){e.getFile(c,k,S(function(e){e.createWriter(S(function(n){n.onwriteend=function(t){b.location.href=e.toURL(),w.readyState=w.DONE,m(w,"writeend",t),h(e)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&D()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=w["on"+e]}),n.write(t),w.abort=function(){n.abort(),w.readyState=w.DONE},w.readyState=w.WRITING}),D)}),D)};e.getFile(c,{create:!1},S(function(e){e.remove(),n()}),S(function(e){e.code===e.NOT_FOUND_ERR?n():D()}))}),D)}),D)):void D())},b=g.prototype,v=function(e,t,n){return new g(e,t,n)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t||"download")}:(b.abort=function(){var e=this;e.readyState=e.DONE,m(e,"abort")},b.readyState=b.INIT=0,b.WRITING=1,b.DONE=2,b.error=b.onwritestart=b.onprogress=b.onwrite=b.onabort=b.onerror=b.onwriteend=null,v)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),function(e){"use strict";var t,n=e.Uint8Array,r=e.HTMLCanvasElement,o=r&&r.prototype,i=/\s*;\s*base64\s*(?:;|$)/i,a="toDataURL",s=function(e){for(var r,o,i,a=e.length,s=new n(a/4*3|0),u=0,c=0,d=[0,0],f=0,l=0;a--;)o=e.charCodeAt(u++),r=t[o-43],255!==r&&r!==i&&(d[1]=d[0],d[0]=o,l=l<<6|r,f++,4===f&&(s[c++]=l>>>16,61!==d[1]&&(s[c++]=l>>>8),61!==d[0]&&(s[c++]=l),f=0));return s};n&&(t=new n([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),r&&!o.toBlob&&(o.toBlob=function(e,t){if(t||(t="image/png"),this.mozGetAsFile)return void e(this.mozGetAsFile("canvas",t));if(this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(t))return void e(this.msToBlob());var r,o=Array.prototype.slice.call(arguments,1),u=this[a].apply(this,o),c=u.indexOf(","),d=u.substring(c+1),f=i.test(u.substring(0,c));Blob.fake?(r=new Blob,f?r.encoding="base64":r.encoding="URI",r.data=d,r.size=d.length):n&&(r=f?new Blob([s(d)],{type:t}):new Blob([decodeURIComponent(d)],{type:t})),e(r)},o.toDataURLHD?o.toBlobHD=function(){a="toDataURLHD";var e=this.toBlob();return a="toDataURL",e}:o.toBlobHD=o.toBlob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this),function(){"use strict";var e={scaleImage:function(e,t){return new Promise(function(n,r){var o=new Sizor;o.scale(e,t).then(n)})},buildPalette:function(e,t,n,r){return this.workor.dispatchWorker(function(e,t,n,r){var o=new Quantizor(e,n,r),i=o.buildPalette(t);return[[e,i],[e.data.buffer]]},[e,t,n,r],[e.data.buffer])},quantize:function(e,t,n,r){return this.workor.dispatchWorker(function(e,t,n,r){var o=new Quantizor(e,n,r),i=o.quantize(t);return[i,[i.data.buffer]]},[e,t,n,r],[e.data.buffer])},pixelate:function(e,t,n,r,o,i){return this.workor.dispatchWorker(function(e,t,n,r,o,i){var a=new Pixelator(e,t,n,r,o,i),s=a.run();return[s,[s.data.buffer]]},[e,t,n,r,o,i],[e.data.buffer])}};self.processingFunctions=e}(),function(){"use strict";Polymer({is:"cross-stitch",behaviors:[window.processingFunctions],properties:{numcolors:{type:Number,observer:"propertyChanged"},gridwidth:{type:Number,observer:"propertyChanged"},imagedata:{type:Object,observer:"propertyChanged"},usedmccolors:{type:Boolean,observer:"propertyChanged"},hidethegrid:{type:Boolean,observer:"propertyChanged"},highqualitymode:{type:Boolean,observer:"propertyChanged"},palette:{type:Array,notify:!0},numberOfCores:{type:Number,value:4},numberOfChunksDone:{type:Number,value:0},workor:{type:Object}},ready:function(){var e=this.$.finalOutput;e.imageSmoothingEnabled=e.msImageSmoothingEnabled=e.mozImageSmoothingEnabled=e.webkitImageSmoothingEnabled=!1,window.addEventListener("resize",_.debounce(this.propertyChanged.bind(this),250)),this.numberOfCores=navigator.hardwareConcurrency||4,this.workor=new Workor(this.numberOfCores)},propertyChanged:function(){void 0!==this.imagedata&&this.newFile()},newFile:function(){var e=this;this.startTime=performance.now(),this.resizeAbsurdImageData.bind(this)(),this.scaleImage(this.imagedata,Polymer.dom(this).node.offsetWidth).then(function(t){return e.buildPalette(t,e.numcolors,e.usedmccolors,e.highqualitymode)}).then(function(t){var n=t[0],r=t[1];e.manipulateImage.bind(e)(n,r)})},manipulateImage:function(e,t){var n=this;this.palette=t;var r=this.$.finalOutput.getContext("2d"),o=this.gridwidth,i=Math.floor(e.height*(this.gridwidth/e.width)),a=Math.ceil(e.width/o),s=Math.ceil(e.height/i);this.$.finalOutput.width=e.width,this.$.finalOutput.height=e.height;for(var u=function(){if(d){if(f>=c.length)return"break";l=c[f++]}else{if(f=c.next(),f.done)return"break";l=f.value}var e=l.chunk,u=l.chunkStartY;n.quantize(e,t,n.usedmccolors,n.highqualitymode).then(function(e){return n.pixelate(e,a,s,o,i,n.hidethegrid)}).then(function(e){r.putImageData(ImageDataHelpers.convertToRealImageData(e),0,u),console.log("Wrote chunk at "+(performance.now()-n.startTime)+" milliseconds!"),++n.numberOfChunksDone===n.numberOfCores&&n.fire("crossStitchDone",ImageDataHelpers.readImageData(n.$.finalOutput))})},c=this.splitGenerator.bind(this)(e,this.numberOfCores,s),d=Array.isArray(c),f=0,c=d?c:c[Symbol.iterator]();;){var l,h=u();if("break"===h)break}},saveAsImage:function(){this.$.finalOutput.getContext("2d");this.$.finalOutput.toBlob(function(e){saveAs(e,"CrossStitch.png")})},getImageAsURI:function(){return this.$.finalOutput.toDataURL("image/png")},resizeAbsurdImageData:function(){var e=this,t=Math.max(window.innerWidth,window.innerHeight);this.imagedata.width>t&&this.scaleImage(this.imagedata,t).then(function(t){e.imagedata=t,console.log("Downscaled really big image")})},splitGenerator:regeneratorRuntime.mark(function e(t,n,r){var o,i,a,s,u,c,d,f,l,h;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=t.data,i=t.width,a=t.height,s=Math.floor(a/n),u=Math.ceil(s/r),c=u*r,d=document.createElement("canvas"),f=d.getContext("2d"),ImageDataHelpers.writeImageData(d,t),l=0;case 10:if(!(n>l)){e.next=18;break}return h=l*c,l===n-1&&(c=a-c*l),e.next=15,{chunk:f.getImageData(0,h,i,c),chunkStartY:h};case 15:l++,e.next=10;break;case 18:case"end":return e.stop()}},e,this)}),_catchErrors:function(e){console.error(e.stack)}})}();</script>
